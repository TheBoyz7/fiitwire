<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SportsWire | Teams</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/teams.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="logo"><h1>SportsWire</h1></div>
      <nav class="main-nav">
        <ul>
          <li><a href="index.php">Home</a></li>
          <li><a href="news.php">News</a></li>
          <li><a href="league.html">Leagues</a></li>
          <li><a href="team.html">Teams</a></li>
          <li><a href="live.html">Live Scores</a></li>
        </ul>
      </nav>
     
    </div>
  </header>

  <div class="team-tabs" id="league-tabs">
    <!-- Tabs will be loaded here dynamically -->
  </div>

  <div id="team-sections">
    <!-- Team cards will be rendered here -->
  </div>

  <script>
    const leagueTabs = document.getElementById("league-tabs");
    const teamSections = document.getElementById("team-sections");

    const apiBase = "http://localhost:3000/api"; // 🔁 Adjust if hosted elsewhere

    async function fetchLeagues() {
      try {
        const res = await fetch(`${apiBase}/leagues?include=seasons`);
        const leagues = await res.json();

        // Filter for domestic leagues only
        const domesticLeagues = leagues.filter(league => league.sub_type === "domestic");

        leagueTabs.innerHTML = ""; // Clear tabs
        domesticLeagues.forEach((league, index) => {
          // Find the current season for the league
          const currentSeason = league.seasons?.find(season => season.is_current) || {};
          const btn = document.createElement("button");
          btn.className = `tab${index === 0 ? " active" : ""}`;
          btn.setAttribute("data-league-id", league.id);
          btn.setAttribute("data-season-id", currentSeason.id || "");
          btn.innerText = league.name;
          btn.addEventListener("click", () => handleTabClick(btn, league.id, currentSeason.id));
          leagueTabs.appendChild(btn);
        });

        // Load the first league by default if available
        if (domesticLeagues.length) {
          const firstTab = leagueTabs.querySelector(".tab");
          const firstLeague = domesticLeagues[0];
          const currentSeason = firstLeague.seasons?.find(season => season.is_current) || {};
          handleTabClick(firstTab, firstLeague.id, currentSeason.id);
        } else {
          teamSections.innerHTML = `<p>No domestic leagues available.</p>`;
        }
      } catch (err) {
        console.error("🛑 Failed to fetch leagues", err);
        teamSections.innerHTML = `<p>Failed to load leagues. Please try again later.</p>`;
      }
    }

    async function fetchTeams(seasonId, leagueId) {
      try {
        if (!seasonId) {
          console.warn("⚠️ No season ID provided, skipping standings fetch");
          return [];
        }
        // Fetch standings for the given season
        const res = await fetch(`${apiBase}/standings/${seasonId}`);
        const standings = await res.json();

        // Filter teams by league_id and map to required fields
        const filteredTeams = standings.data
          .filter(standing => standing.league_id === leagueId)
          .map(standing => ({
            id: standing.participant.id,
            name: standing.participant.name,
            short_code: standing.participant.short_code,
            image_path: standing.participant.image_path,
            position: standing.position // Include position for display
          }));

        // Sort teams alphabetically by name
        filteredTeams.sort((a, b) => a.name.localeCompare(b.name));

        return filteredTeams;
      } catch (err) {
        console.error("🛑 Failed to fetch teams from standings", err);
        return [];
      }
    }

    async function handleTabClick(tabBtn, leagueId, seasonId) {
      document.querySelectorAll(".tab").forEach(btn => btn.classList.remove("active"));
      tabBtn.className = "tab active";

      teamSections.innerHTML = `<p>Loading teams...</p>`;

      const teams = await fetchTeams(seasonId, leagueId);

      if (!teams.length) {
        teamSections.innerHTML = `<p>No teams available for this league.</p>`;
        return;
      }

      const grid = document.createElement("div");
      grid.className = "teams-grid";

      teams.forEach(team => {
        const card = document.createElement("div");
        card.className = "team-card";
        card.innerHTML = `
          <img src="${team.image_path || 'images/default-logo.png'}" alt="${team.name}" />
          <h2>${team.name}</h2>
          <p>${team.short_code || "Top tier football club"} (Position: ${team.position})</p>
          <a href="club.html?id=${team.id}">View</a>
        `;
        grid.appendChild(card);
      });

      teamSections.innerHTML = "";
      teamSections.appendChild(grid);
    }

    // Initialize on load
    document.addEventListener("DOMContentLoaded", fetchLeagues);
  </script>
</body>
</html>